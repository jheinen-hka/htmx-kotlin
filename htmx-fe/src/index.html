<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="HTMX in Kotlin for Projektarbeit 2 in Master">
    <meta name="author" content="Josiah Heinen - hejo1030 - 61728">
    <title>HTMX Kotlin Demo Dashboard</title>

    <!-- Pico.css for base styling and components -->
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">

    <!-- Custom styling on top of Pico -->
    <link rel="stylesheet" href="./style.css">

    <!-- HTMX via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7"></script>
    <script>
        // Allow cross-origin requests to the Kotlin backend running on localhost:8080
        htmx.config.selfRequestsOnly = false;
    </script>
</head>
<body>
<main class="container dashboard">

    <!-- Global error banner for HTMX/network/server errors.
         Hidden by default, shown via JavaScript when HTMX error events fire. -->
    <div id="htmx-error-banner" class="error-banner" hidden>
        <strong>Warning:</strong>
        <span id="htmx-error-text">An error occurred while talking to the server.</span>
    </div>

    <header class="hero">
        <div class="hero-text">
            <span class="badge">HTMX + Kotlin</span>
            <h1>Interactive Demo Dashboard</h1>
            <p>
                A small dashboard that demonstrates HTML-over-the-wire with HTMX
                and a Kotlin / Spring Boot backend. The same services can be used
                by JSON APIs and the HTMX-based UI.
            </p>
        </div>
    </header>

    <section class="grid">
        <!-- ===================== MESSAGE CENTER CARD ===================== -->
        <article class="card card-primary">
            <header>
                <h2>Message Center</h2>
                <p class="subtitle">
                    A simple message board that demonstrates server-rendered HTML fragments.
                </p>
                <p class="subtitle">
                    In this card you can post new messages and refresh the list without a full page reload.
                    HTMX attributes used here:
                    <code>hx-post</code> (submit the form via POST),
                    <code>hx-get</code> (load messages),
                    <code>hx-target</code> and <code>hx-swap</code> (where and how to insert the HTML),
                    and <code>hx-on::after-request</code> (reset the form after a successful request).
                </p>
            </header>

            <section>
                <!-- HTMX: hx-post sends the form data via HTTP POST to the backend.
                     hx-target defines the element whose content will be replaced by the response.
                     hx-swap="innerHTML" replaces only the inner HTML of the target.
                     hx-on::after-request runs the handler after any htmx request from this element;
                     event.detail.successful is true for 2xx responses, then this.reset() clears the form. -->
                <form class="compact-form"
                      id="new-message-form"
                      action="http://localhost:8080/htmx/add-message"
                      method="post"
                      hx-post="http://localhost:8080/htmx/add-message"
                      hx-target="#messages"
                      hx-swap="innerHTML"
                      hx-on::after-request="if (event.detail.successful) this.reset()">
                    <label>
                        <span class="field-label">New message</span>
                        <input type="text"
                               name="message"
                               placeholder="Type a message and press Enter"
                               required>
                    </label>
                    <button type="submit" class="primary">
                        Send
                    </button>
                </form>

                <div class="toolbar">
                    <!-- HTMX: hx-get triggers a GET request to reload the messages.
                         hx-target points to the messages container.
                         hx-swap="innerHTML" replaces only the inner content.
                         hx-indicator shows a loading spinner while the request is in-flight. -->
                    <button class="secondary outline small"
                            hx-get="http://localhost:8080/htmx/messages"
                            hx-target="#messages"
                            hx-swap="innerHTML"
                            hx-indicator="#messages-indicator">
                        ↻ Refresh
                    </button>
                    <span id="messages-indicator"
                          class="loading-indicator"
                          aria-hidden="true"></span>
                    <small class="toolbar-hint">
                        Messages are fully rendered on the server and swapped into this card.
                    </small>
                </div>

                <!-- HTMX: hx-get loads the initial message list when the element is added to the DOM.
                     hx-trigger="load" fires once when the element is loaded.
                     hx-indicator points to a spinner that is shown while loading. -->
                <div id="messages"
                     class="message-list"
                     hx-get="http://localhost:8080/htmx/messages"
                     hx-trigger="load"
                     hx-indicator="#messages-indicator">
                    Loading messages...
                </div>
            </section>
        </article>

        <!-- ===================== TASK BOARD CARD ===================== -->
        <article class="card">
            <header>
                <h2>Task Board</h2>
                <p class="subtitle">
                    A small task list that demonstrates CRUD-style interactions with HTMX.
                </p>
                <p class="subtitle">
                    In this card you can create tasks, load the task list and interact with
                    server-rendered buttons for toggling and deleting tasks.
                    HTMX attributes here include:
                    <code>hx-post</code> and <code>hx-get</code> (create and load),
                    <code>hx-target</code>/<code>hx-swap</code> (swap the list container),
                    and <code>hx-on::after-request</code> to clear the form after successful requests.
                </p>
            </header>

            <section>
                <!-- HTMX: hx-post sends the new task title to the backend via POST.
                     hx-target points to the task-list container which will be replaced.
                     hx-swap="outerHTML" replaces the entire task-list element.
                     hx-on::after-request resets the form on successful HTMX responses. -->
                <form class="compact-form"
                      action="http://localhost:8080/htmx/tasks"
                      method="post"
                      hx-post="http://localhost:8080/htmx/tasks"
                      hx-target="#task-list"
                      hx-swap="outerHTML"
                      hx-on::after-request="if (event.detail.successful) this.reset()">
                    <label>
                        <span class="field-label">New task</span>
                        <input type="text"
                               name="title"
                               placeholder="Describe a task"
                               required>
                    </label>
                    <button type="submit" class="secondary">
                        Add task
                    </button>
                </form>

                <div class="toolbar">
                    <!-- HTMX: hx-get loads or reloads the task list from the backend.
                         hx-target selects the task-list container to update.
                         hx-swap="outerHTML" swaps the entire container.
                         hx-indicator shows a loading spinner while the request is running. -->
                    <button class="secondary outline small"
                            hx-get="http://localhost:8080/htmx/tasks"
                            hx-target="#task-list"
                            hx-swap="outerHTML"
                            hx-indicator="#tasks-indicator">
                        Load tasks
                    </button>
                    <span id="tasks-indicator"
                          class="loading-indicator"
                          aria-hidden="true"></span>
                    <small class="toolbar-hint">
                        Tasks are rendered on the server. Toggle and delete actions are provided
                        by HTMX attributes in the server response.
                    </small>
                </div>

                <!-- HTMX: hx-get triggers the initial load of tasks when the element is loaded.
                     hx-trigger="load" ensures the request runs once on page load.
                     hx-swap="outerHTML" allows the backend to return a complete replacement div.
                     hx-indicator references the spinner for loading state. -->
                <div id="task-list"
                     class="placeholder-box"
                     hx-get="http://localhost:8080/htmx/tasks"
                     hx-trigger="load"
                     hx-swap="outerHTML"
                     hx-indicator="#tasks-indicator">
                    <p class="muted">
                        The initial task list is loaded from the backend when this card becomes visible.
                    </p>
                </div>
            </section>
        </article>

        <!-- ===================== USER CARD (FULL CRUD) ===================== -->
        <article class="card">
            <header>
                <h2>User Card</h2>
                <p class="subtitle">
                    Demonstrates CRUD operations for a richer domain object with multiple fields.
                    Each row can be edited inline via HTMX.
                </p>
                <p class="subtitle">
                    In this card you can create users, load the full user table,
                    and use server-rendered buttons to edit or delete users.
                    HTMX attributes here use:
                    <code>hx-post</code> (create),
                    <code>hx-get</code> (load and switch to edit view),
                    <code>hx-put</code> (update via inline form),
                    <code>hx-delete</code> (delete a row),
                    <code>hx-target="closest tr"</code> (update only the clicked row),
                    <code>hx-swap="outerHTML"</code> (replace the row),
                    and <code>hx-include</code> (include field values from the row in the request).
                </p>
            </header>

            <section>
                <!-- HTMX: hx-post submits the user creation form as application/x-www-form-urlencoded.
                     hx-target points to the #user-list container.
                     hx-swap="outerHTML" replaces the entire user list container.
                     hx-on::after-request resets the form when the user was successfully created. -->
                <form class="user-form"
                      action="http://localhost:8080/htmx/users"
                      method="post"
                      hx-post="http://localhost:8080/htmx/users"
                      hx-target="#user-list"
                      hx-swap="outerHTML"
                      hx-on::after-request="if (event.detail.successful) this.reset()">
                    <div class="user-form-row">
                        <label>
                            <span class="field-label">First name</span>
                            <input type="text"
                                   name="firstName"
                                   placeholder="First name"
                                   required>
                        </label>
                        <label>
                            <span class="field-label">Last name</span>
                            <input type="text"
                                   name="lastName"
                                   placeholder="Last name"
                                   required>
                        </label>
                    </div>
                    <div class="user-form-row">
                        <label>
                            <span class="field-label">Age</span>
                            <input type="number"
                                   name="age"
                                   min="0"
                                   max="130"
                                   placeholder="Age">
                        </label>
                        <label>
                            <span class="field-label">Gender</span>
                            <select name="gender">
                                <option value="">Select gender</option>
                                <option value="FEMALE">Female</option>
                                <option value="MALE">Male</option>
                                <option value="OTHER">Other</option>
                                <option value="UNKNOWN">Prefer not to say</option>
                            </select>
                        </label>
                    </div>
                    <button type="submit" class="secondary">
                        Create user
                    </button>
                </form>

                <div class="toolbar">
                    <!-- HTMX: hx-get loads or reloads the entire user list table.
                         hx-target is the #user-list container.
                         hx-swap="outerHTML" replaces the whole box so the backend controls the markup.
                         hx-indicator references the spinner for loading state. -->
                    <button class="secondary outline small"
                            hx-get="http://localhost:8080/htmx/users"
                            hx-target="#user-list"
                            hx-swap="outerHTML"
                            hx-indicator="#users-indicator">
                        Load users
                    </button>
                    <span id="users-indicator"
                          class="loading-indicator"
                          aria-hidden="true"></span>
                    <small class="toolbar-hint">
                        User details, edit and delete actions are rendered on the server as HTMX-enabled HTML.
                    </small>
                </div>

                <!-- HTMX: hx-get fetches the initial user table when the card is loaded.
                     hx-trigger="load" fires when the element is added to the DOM.
                     hx-swap="outerHTML" lets the backend return a full replacement div.
                     hx-indicator shows a spinner while the request is active. -->
                <div id="user-list"
                     class="placeholder-box"
                     hx-get="http://localhost:8080/htmx/users"
                     hx-trigger="load"
                     hx-swap="outerHTML"
                     hx-indicator="#users-indicator">
                    <p class="muted">
                        The initial list of users will be loaded from the backend. Each row provides
                        edit and delete actions rendered by the server.
                    </p>
                </div>
            </section>
        </article>

        <!-- ===================== LIVE USER SEARCH CARD ===================== -->
        <article class="card">
            <header>
                <h2>Live User Search</h2>
                <p class="subtitle">
                    Live, debounced search over all users using HTMX and server-side filtering.
                </p>
                <p class="subtitle">
                    In this card you can search through the demo users by name and optional gender filter.
                    HTMX attributes used:
                    <code>hx-get</code> (send search queries to the server),
                    <code>hx-trigger</code> with <code>delay</code> (debounced requests),
                    <code>hx-target</code> (where to render the results),
                    <code>hx-indicator</code> (show a loading spinner),
                    and <code>hx-include</code> (include additional filter fields in the request).
                </p>
            </header>

            <section>
                <div class="user-form-row">
                    <!-- HTMX: hx-get sends a GET request to the search endpoint whenever the trigger fires.
                         hx-target points to the #user-search-results box to be updated.
                         hx-trigger="keyup changed delay:300ms" debounces input so the request is delayed 300ms after typing stops.
                         hx-indicator references a spinner element shown while loading.
                         hx-include includes the gender select field as extra query parameters. -->
                    <label>
                        <span class="field-label">Search term</span>
                        <input id="user-search-input"
                               type="search"
                               name="q"
                               placeholder="Type a name (e.g. Alex, Chris, Sam)"
                               hx-get="http://localhost:8080/htmx/users/search"
                               hx-target="#user-search-results"
                               hx-trigger="keyup changed delay:300ms"
                               hx-indicator="#user-search-indicator"
                               hx-include="#user-search-gender">
                    </label>

                    <!-- HTMX: hx-get sends a GET request when the gender select changes.
                         hx-target updates the same results container.
                         hx-trigger="change" fires when the select value changes.
                         hx-indicator shows the spinner.
                         hx-include adds the current search term input to the request so both q and gender are sent. -->
                    <label>
                        <span class="field-label">Gender filter</span>
                        <select id="user-search-gender" name="gender"
                                hx-get="http://localhost:8080/htmx/users/search"
                                hx-target="#user-search-results"
                                hx-trigger="change"
                                hx-indicator="#user-search-indicator"
                                hx-include="#user-search-input">
                            <option value="">All genders</option>
                            <option value="FEMALE">Female</option>
                            <option value="MALE">Male</option>
                            <option value="OTHER">Other</option>
                            <option value="UNKNOWN">Prefer not to say</option>
                        </select>
                    </label>
                </div>

                <div class="toolbar">
                    <span id="user-search-indicator"
                          class="loading-indicator"
                          aria-hidden="true"></span>
                    <small class="toolbar-hint">
                        HTMX sends <code>q</code> and <code>gender</code> as query parameters to
                        <code>/htmx/users/search</code> with a small debounce delay.
                    </small>
                </div>

                <div id="user-search-results" class="placeholder-box">
                    <p class="muted">
                        Type at least one character or choose a gender to search in the demo user set.
                        Results are rendered on the server and swapped into this area.
                    </p>
                </div>
            </section>
        </article>
    </section>

    <footer class="footer">
        <small>Project: HTMX in Kotlin · Projektarbeit 2 · Josiah Heinen · 61728</small>
        <small>Backend: Spring Boot (Kotlin) · Frontend: HTMX + Pico.css</small>
    </footer>
</main>

<!-- Global HTMX error handling script.
     Keeps network errors visible until a successful request happens. -->
<script>
    // Tracks whether we have a persistent "server unreachable" situation.
    let htmxServerIssue = false;

    // Handle network-level errors: server not reachable, DNS issues, CORS, etc.
    document.body.addEventListener('htmx:sendError', function (event) {
        htmxServerIssue = true;
        showHtmxError('Network error: could not reach the server.', true);
    });

    // Handle HTTP errors: 4xx/5xx status codes from the server.
    document.body.addEventListener('htmx:responseError', function (event) {
        const status = event.detail.xhr ? event.detail.xhr.status : 'unknown';
        showHtmxError('Server error: request failed with status ' + status + '.', false);
    });

    // Handle timeout events if a request takes too long.
    document.body.addEventListener('htmx:timeout', function (event) {
        showHtmxError('Request timeout: the server took too long to respond.', false);
    });

    // If there was a server issue and we get a successful response again,
    // we hide the banner because connectivity is restored.
    document.body.addEventListener('htmx:afterRequest', function (event) {
        if (event.detail.successful && htmxServerIssue) {
            hideHtmxError();
            htmxServerIssue = false;
        }
    });

    // Show the error banner. If "persistent" is true, do not auto-hide.
    function showHtmxError(message, persistent) {
        const banner = document.getElementById('htmx-error-banner');
        const text = document.getElementById('htmx-error-text');
        if (!banner || !text) return;

        text.textContent = message;
        banner.hidden = false;

        // Cancel any previous auto-hide
        window.clearTimeout(banner._hideTimeout);

        // Only auto-hide if not persistent
        if (!persistent) {
            banner._hideTimeout = window.setTimeout(function () {
                banner.hidden = true;
            }, 6000);
        }
    }

    // Explicit helper to hide the error banner.
    function hideHtmxError() {
        const banner = document.getElementById('htmx-error-banner');
        if (!banner) return;
        banner.hidden = true;
    }
</script>

</body>
</html>
